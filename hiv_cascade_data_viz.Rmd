---
title: "HIV Treatment Cascade - Data Visualization"
author: "Brittany Bowman"
date: "10/8/2019"
output: html_document
runtime: shiny
---

This file provides a script for visualizing the HIV treatment cascade data from UNAIDS from 2015-2018 related to progress towards the 90-90-90 targets.
```{r setup, include=FALSE echo = FALSE}
# load necessary packages
library(tidyverse)
library(shiny)
library(plotly)
library(scales)
library(ggthemes)
library(RColorBrewer)
library(grDevices)

# get working directory
getwd()

# load tidy datasets (g = global datasets, c = country datasets)
full_cascade_g <- read_rds("data/tidy_data/full_cascade_global_tidy")
full_cascade_c <- read_rds("data/tidy_data/full_cascade_country_tidy")

know_status_g <- read_rds("data/tidy_data/know_status_all_global_tidy")
know_status_c <- read_rds("data/tidy_data/know_status_all_country_tidy")

on_art_g <- read_rds("data/tidy_data/on_art_all_global_tidy")
on_art_c <- read_rds("data/tidy_data/on_art_all_country_tidy")

vl_suppress_g <- read_rds("data/tidy_data/vl_suppress_all_global_tidy")
vl_suppress_c <- read_rds("data/tidy_data/vl_suppress_all_country_tidy")
```


```{r}
# define color palette (RBrewerPal palette Set1 with black inserted for global)
custom_palette <- c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#000000", "#FF7F00", "#FFFF33", "#A65628", "#F781BF")

# define custom theme
custom_theme <- theme_tufte() +
                theme(text = element_text(family = "Helvetica"),
                      plot.title = element_text(face = "bold", size = 16, color = "grey20"),
                      plot.title.position = "plot",
                      plot.subtitle = element_text(margin = margin(b = 16)),
                      plot.caption = element_text(hjust = 0, margin = margin(t = 10)),
                      plot.caption.position = "plot",
                      axis.line.x = element_line(colour = "grey20", size = 0.25, linetype = "solid"), 
                      axis.line.y = element_line(colour = "grey20", size = 0.25, linetype = "solid"),
                      axis.text = element_text(size = 10),
                      legend.title = element_blank(),
                      legend.text = element_text(size = 10))

theme_set(custom_theme)
```


```{r}
# plot of percent of people living with HIV who know their status
know_status_g %>% 
  ggplot(aes(x = year, y = estimate, color = Region, group = rev(Region))) + 
  geom_point(alpha = 0.75) + 
  geom_line(alpha = 0.75) +
  geom_hline(yintercept = 90, alpha = 0.75, linetype = 3) + 
  scale_color_manual(values = custom_palette) +
  scale_y_continuous(labels = percent_format(scale = 1),
                     breaks = pretty_breaks(n = 10), 
                     expand = expansion(add = 10)) +
  scale_x_discrete(expand = expansion(add = 0.1)) +
  labs(x = NULL, y = NULL, 
       title = "Percent of people living with HIV who know their status by region",
       subtitle = "Figure based on modeled estimates from UNAIDS for all ages",
       caption = "Source: UNAIDS special analysis, 2019") +
  annotate("text", x = 3.3, y = 92, 
           label = "paste(bold(\"UNAIDS target:\"), \" 90% of people living with HIV know their status by 2020\")", 
           parse = TRUE, size = 3.2, color = "grey20") +
  annotate("curve", x = 4, xend = 4.05, y = 92, yend = 90.3, 
           curvature = -0.9, angle = 90,
           arrow = arrow(length = unit(0.01, "npc")),
           color = "grey20")
```


```{r}
# plot of percent of people who know their HIV-positive status who are accessing treatment
full_cascade_g %>% 
  filter(measure_type == "know_status_on_art", age == "all") %>%
  ggplot(aes(x = year, y = estimate, color = Region, group = rev(Region))) + 
  geom_point(alpha = 0.75) + 
  geom_line(alpha = 0.75) +
  geom_hline(yintercept = 90, alpha = 0.75, linetype = 3) + 
  scale_color_manual(values = custom_palette) +
  scale_y_continuous(labels = percent_format(scale = 1),
                     breaks = pretty_breaks(n = 10), 
                     expand = expansion(add = 8)) +
  scale_x_discrete(expand = expansion(add = 0.1)) +
  labs(x = NULL, y = NULL, 
       title = "Percent of people who know their HIV-positive status who are on ART by region",
       subtitle = "Figure based on modeled estimates from UNAIDS for all ages",
       caption = "Source: UNAIDS special analysis, 2019") +
  annotate("text", x = 3.1, y = 92, 
           label = "paste(bold(\"UNAIDS target:\"), \" 90% of people who know their HIV-positive status access treatment by 2020\")", 
           parse = TRUE, size = 3.2, color = "grey20") +
  annotate("curve", x = 4, xend = 4.05, y = 92, yend = 90.3, 
           curvature = -0.9, angle = 90,
           arrow = arrow(length = unit(0.01, "npc")),
           color = "grey20")
```


```{r}
# plot of percent of people on ART who achieve viral suppression
full_cascade_g %>% 
  filter(measure_type == "on_art_vl_suppress", age == "all") %>%
  ggplot(aes(x = year, y = estimate, color = Region, group = rev(Region))) + 
  geom_point(alpha = 0.75) + 
  geom_line(alpha = 0.75) +
  geom_hline(yintercept = 90, alpha = 0.75, linetype = 3) + 
  scale_color_manual(values = custom_palette) +
  scale_y_continuous(labels = percent_format(scale = 1),
                     breaks = pretty_breaks(n = 10), 
                     expand = expansion(add = 8)) +
  scale_x_discrete(expand = expansion(add = 0.1)) +
  labs(x = NULL, y = NULL, 
       title = "Percent of people on ART who achieve viral suppression by region",
       subtitle = "Figure based on modeled estimates from UNAIDS for all ages",
       caption = "Source: UNAIDS special analysis, 2019") +
  annotate("text", x = 3.2, y = 92, 
           label = "paste(bold(\"UNAIDS target:\"), \" 90% of people on treatment have suppressed viral loads by 2020\")", 
           parse = TRUE, size = 3.2, color = "grey20") +
  annotate("curve", x = 4, xend = 4.05, y = 92, yend = 90.3, 
           curvature = -0.9, angle = 90,
           arrow = arrow(length = unit(0.01, "npc")),
           color = "grey20")
```


```{r}
# plot of progress towards 90-90-90 faceted by region
full_cascade_g %>% 
  filter(measure_type %in% c("know_status", "know_status_on_art", "on_art_vl_suppress"), 
         age == "all", year == "2018") %>%
  ggplot(aes(x = factor(measure_type, ordered = is.ordered(c("know_status", "know_status_on_art", "on_art_vl_suppress"))), 
                        y = estimate, color = Region, group = rev(Region))) + 
  geom_point() +
  geom_linerange(aes(ymin = lower_ci, ymax = upper_ci)) +
  geom_hline(yintercept = 90, alpha = 0.75, linetype = 3) + 
  facet_wrap(~ Region, nrow = 3) +
  scale_color_manual(values = custom_palette, guide = FALSE) +
  scale_y_continuous(labels = percent_format(scale = 1),
                     breaks = pretty_breaks(n = 10), 
                     expand = expansion(add = 10)) +
  scale_x_discrete(expand = expansion(add = 0.25),
                   labels = c("People living with\n HIV who know\n their status",
                              "People who know\n their status\n who are on ART",
                              "People on ART\n who acheive\n viral suppression")) +
  labs(x = NULL, y = NULL, 
       title = "Progress towards 90-90-90 targets by region",
       subtitle = "Figure based on modeled estimates from UNAIDS for all ages",
       caption = "Source: UNAIDS special analysis, 2019") +
  theme(axis.text.x = element_text(size = 8),
        panel.spacing.x = unit(40, units = "pt"))
```


```{r}
# plot of overall progress towards each goal as a percent of total people living with HIV
full_cascade_g %>% 
  filter(measure_type %in% c("know_status", "hiv_on_art", "hiv_vl_suppress"), 
         age == "all", year == "2018") %>%
  ggplot(aes(x = factor(measure_type, ordered = is.ordered(c("know_status", "hiv_on_art", "hiv_vl_suppress"))), 
                        y = estimate, color = Region, group = rev(Region))) + 
  geom_point() +
  geom_linerange(aes(ymin = lower_ci, ymax = upper_ci)) +
  facet_wrap(~ Region, nrow = 3) +
  scale_color_manual(values = custom_palette, guide = FALSE) +
  scale_y_continuous(labels = percent_format(scale = 1),
                     breaks = pretty_breaks(n = 10), 
                     expand = expansion(add = 10)) +
  scale_x_discrete(expand = expansion(add = 0.25),
                   labels = c("People living with HIV\n who know their status",
                              "People living with HIV\n who are on ART",
                              "People living with HIV\n who acheive viral suppression")) +
  labs(x = NULL, y = NULL, 
       title = "Percent of all people living with HIV reaching each target by region",
       subtitle = "Figure based on modeled estimates from UNAIDS for all ages",
       caption = "Source: UNAIDS special analysis, 2019") +
  theme(axis.text.x = element_text(size = 8),
        panel.spacing.x = unit(40, units = "pt"))
```


